From 91f8f8d5d2ef07d46174ebcd3c7cf78f263ebd3e Mon Sep 17 00:00:00 2001
From: Jaegeuk Kim <jaegeuk@kernel.org>
Date: Tue, 31 Jan 2017 18:16:30 -0800
Subject: [PATCH] test atomic write

Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
---
 fs/f2fs/data.c    | 2 +-
 fs/f2fs/file.c    | 3 ++-
 fs/f2fs/segment.h | 4 +++-
 3 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/fs/f2fs/data.c b/fs/f2fs/data.c
index a1d5861..7c4b81a 100644
--- a/fs/f2fs/data.c
+++ b/fs/f2fs/data.c
@@ -1324,7 +1324,7 @@ retry_encrypt:
 	 */
 	if (unlikely(fio->old_blkaddr != NEW_ADDR &&
 			!is_cold_data(page) &&
-			!IS_ATOMIC_WRITTEN_PAGE(page) &&
+			//!IS_ATOMIC_WRITTEN_PAGE(page) &&
 			need_inplace_update(inode))) {
 		rewrite_data_page(fio);
 		set_inode_flag(inode, FI_UPDATE_WRITE);
diff --git a/fs/f2fs/file.c b/fs/f2fs/file.c
index a11a49e..53fde3d 100644
--- a/fs/f2fs/file.c
+++ b/fs/f2fs/file.c
@@ -278,7 +278,8 @@ sync_nodes:
 flush_out:
 	remove_ino_entry(sbi, ino, UPDATE_INO);
 	clear_inode_flag(inode, FI_UPDATE_WRITE);
-	ret = f2fs_issue_flush(sbi);
+	if (!atomic)
+		ret = f2fs_issue_flush(sbi);
 	f2fs_update_time(sbi, REQ_TIME);
 out:
 	trace_f2fs_sync_file_exit(inode, need_cp, datasync, ret);
diff --git a/fs/f2fs/segment.h b/fs/f2fs/segment.h
index 4b0e1bd..ba55357 100644
--- a/fs/f2fs/segment.h
+++ b/fs/f2fs/segment.h
@@ -554,8 +554,10 @@ static inline bool need_inplace_update(struct inode *inode)
 	unsigned int policy = SM_I(sbi)->ipu_policy;
 
 	/* IPU can be done only for the user data */
-	if (S_ISDIR(inode->i_mode) || f2fs_is_atomic_file(inode))
+	if (S_ISDIR(inode->i_mode)) // || f2fs_is_atomic_file(inode))
 		return false;
+	if (f2fs_is_atomic_file(inode))
+		return true;
 
 	if (test_opt(sbi, LFS))
 		return false;
-- 
1.9.1

